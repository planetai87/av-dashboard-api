<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>고양04 지역대회 AV부 통합 관리 대시보드</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="고양04 AV대시보드" />
    <link rel="apple-touch-icon" href="/icons/icon-180x180.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <!-- Chosen Palette: Calm Neutral Blue -->
    <!-- Application Structure Plan: A tab-based Single Page Application (SPA) with four main sections: 1. Main Dashboard for a high-level overview, 2. Pre-Setup Schedule for detailed task tracking, 3. Operations Schedule for staffing, and 4. Sound Analysis for in-depth audio monitoring. This structure was chosen because it mirrors the logical separation of tasks in the source report (the G-Sheet tabs) while providing a more integrated and fluid user experience. Users can get a quick summary on the dashboard and then dive into specific areas without leaving the page, which is ideal for a real-time monitoring tool. Data is now fetched dynamically from a local Node.js API server. -->
    <!-- Visualization & Content Choices: 
        - [Dashboard] Overall Progress: Goal=Inform. Viz=Donut charts (Chart.js) for intuitive percentage visualization. Interaction=None. Justification=Quick visual summary of completion.
        - [Dashboard] Delayed Tasks: Goal=Inform/Alert. Viz=Dynamic HTML list. Interaction=None. Justification=Highlights critical issues immediately.
        - [Pre-Setup] Task Table: Goal=Organize/Track. Viz=Interactive HTML table. Interaction=Team-based filtering via buttons, status-based color coding. Justification=Allows managers to focus on specific teams and quickly assess task statuses.
        - [Sound Analysis] Heatmap: Goal=Analyze/Compare. Viz=Bubble chart (Chart.js) configured to look like a grid, representing the new 3-5-5 seating layout, with the first row centered. Interaction=Filters by day/time, tooltips on hover. Justification=Provides an immediate, intuitive visual representation of sound distribution across the venue with updated color logic.
        - [Sound Analysis] Trend Graph: Goal=Analyze Change. Viz=Line chart (Chart.js) with annotation plugin for both normal and warning baselines. Interaction=Updates with filters. Justification=Shows sound level trends over time against key thresholds.
        - CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
      body {
        font-family: "Noto Sans KR", sans-serif;
        background-color: #f8fafc;
      }
      .tab-btn,
      .filter-btn {
        transition: all 0.3s ease;
      }
      .tab-btn.active {
        border-color: #3b82f6;
        color: #3b82f6;
        background-color: #eff6ff;
      }
      .filter-btn.active {
        background-color: #3b82f6;
        color: white;
      }
      .filter-btn:not(.active) {
        background-color: white;
        color: #374151;
        border: 1px solid #d1d5db;
      }
      .chart-container {
        position: relative;
        width: 100%;
        margin-left: auto;
        margin-right: auto;
      }
      .task-row.completed {
        background-color: #f1f5f9;
        text-decoration: line-through;
        color: #64748b;
      }
      .task-row.delayed {
        background-color: #fee2e2;
      }
      .task-row.in-progress {
        background-color: #fef9c3;
      }
      #loading-overlay {
        transition: opacity 0.3s ease;
      }
        /* --- MOBILE OPTIMIZATION START --- */
  @media (max-width: 768px) {
    header.flex {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.5rem;
    }

    .tab-btn {
      flex: 1;
      text-align: center;
      font-size: 0.875rem;
      padding: 0.5rem 0.25rem;
    }

    nav.flex {
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 0.5rem;
    }

    .chart-container {
      height: 180px !important;
      width: 100% !important;
    }

    .grid-cols-2,
    .grid-cols-4,
    .md\:grid-cols-2,
    .lg\:grid-cols-4,
    .md\:grid-cols-3,
    .lg\:grid-cols-2 {
      grid-template-columns: repeat(1, minmax(0, 1fr)) !important;
    }

    .sm\:grid-cols-4 {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .text-3xl {
      font-size: 1.5rem !important;
    }
    .text-2xl {
      font-size: 1.25rem !important;
    }
    .text-xl {
      font-size: 1.125rem !important;
    }
    .text-lg {
      font-size: 1rem !important;
    }
    .text-sm {
      font-size: 0.875rem !important;
    }

    .p-6 {
      padding: 1rem !important;
    }
    .p-4 {
      padding: 0.75rem !important;
    }

    .overflow-x-auto table {
      min-width: 720px;
    }

    /* 사전설치 공정표 내 팀, 담당자 너비 증가 */
    #setup-tasks-table td:nth-child(1),
    #setup-tasks-table td:nth-child(3) {
      min-width: 120px;
      white-space: nowrap;
    }
  }
  /* — MOBILE OPTIMIZATION END — */
    </style>
  </head>
  <body class="bg-slate-50 text-slate-800">
    <div
      id="loading-overlay"
      class="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-50"
    >
      <div class="text-center">
        <svg
          class="animate-spin h-8 w-8 text-blue-600 mx-auto mb-4"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
        >
          <circle
            class="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            stroke-width="4"
          ></circle>
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          ></path>
        </svg>
        <p class="text-lg font-semibold text-slate-700">
          API 서버에서 데이터를 불러오는 중입니다...
        </p>
      </div>
    </div>

    <div class="container mx-auto p-4 md:p-6">
      <header class="mb-6 flex justify-between items-center">
        <div>
          <h1 class="text-3xl font-bold text-slate-900">
            고양04 지역대회 AV부 통합 관리 대시보드
          </h1>
          <p class="text-slate-600 mt-1">
            대회 전 사전설치부터 운영까지 모든 현황을 실시간으로 관리합니다.
          </p>
        </div>
        <button
          id="refresh-button"
          class="p-2 rounded-full hover:bg-slate-200 active:bg-slate-300 transition-colors"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="text-slate-600"
          >
            <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" />
            <path d="M21 3v5h-5" />
            <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" />
            <path d="M3 21v-5h5" />
          </svg>
        </button>
      </header>

      <nav class="flex border-b border-slate-200 mb-6 space-x-1">
        <button
          data-tab="dashboard"
          class="tab-btn px-4 py-2 text-sm font-semibold text-slate-600 border-b-2 border-transparent hover:border-blue-500 hover:text-blue-500"
        >
          메인 대시보드
        </button>
        <button
          data-tab="setup"
          class="tab-btn px-4 py-2 text-sm font-semibold text-slate-600 border-b-2 border-transparent hover:border-blue-500 hover:text-blue-500"
        >
          사전설치 공정표
        </button>
        <button
          data-tab="operation"
          class="tab-btn px-4 py-2 text-sm font-semibold text-slate-600 border-b-2 border-transparent hover:border-blue-500 hover:text-blue-500"
        >
          운영 스케줄
        </button>
        <button
          data-tab="sound"
          class="tab-btn px-4 py-2 text-sm font-semibold text-slate-600 border-b-2 border-transparent hover:border-blue-500 hover:text-blue-500"
        >
          음향 분석
        </button>
      </nav>

      <main>
        <!-- Dashboard Content -->
        <div id="dashboard-content" class="content-panel">
          <div class="mb-6">
            <h2 class="text-xl font-bold mb-1">핵심 요약</h2>
            <p class="text-slate-500 text-sm">
              현재 시점의 가장 중요한 정보들을 요약하여 보여줍니다.
            </p>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="bg-white p-6 rounded-lg shadow-sm">
              <h3 class="font-bold text-slate-800 mb-2">전체 공정 진행률</h3>
              <div class="chart-container h-48 w-48 mx-auto">
                <canvas id="overallProgressChart"></canvas>
              </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-sm">
              <h3 class="font-bold text-slate-800 mb-2">팀별 진행률</h3>
              <div class="grid grid-cols-2 gap-4 pt-2">
                <div class="text-center">
                  <div class="chart-container h-20 w-20 mx-auto">
                    <canvas id="audioProgressChart"></canvas>
                  </div>
                  <p class="text-xs font-semibold mt-2">오디오팀</p>
                </div>
                <div class="text-center">
                  <div class="chart-container h-20 w-20 mx-auto">
                    <canvas id="videoProgressChart"></canvas>
                  </div>
                  <p class="text-xs font-semibold mt-2">비디오팀</p>
                </div>
                <div class="text-center">
                  <div class="chart-container h-20 w-20 mx-auto">
                    <canvas id="stageProgressChart"></canvas>
                  </div>
                  <p class="text-xs font-semibold mt-2">무대팀</p>
                </div>
                <div class="text-center">
                  <div class="chart-container h-20 w-20 mx-auto">
                    <canvas id="itProgressChart"></canvas>
                  </div>
                  <p class="text-xs font-semibold mt-2">IT팀</p>
                </div>
              </div>
            </div>
            <div
              class="bg-white p-6 rounded-lg shadow-sm md:col-span-2 lg:col-span-2"
            >
              <h3 class="font-bold text-slate-800 mb-2">
                주의! 지연 작업 목록
              </h3>
              <div
                id="delayed-tasks-list"
                class="space-y-2 text-sm max-h-48 overflow-y-auto"
              >
                <!-- Delayed tasks will be populated by JS -->
              </div>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
            <div class="bg-white p-6 rounded-lg shadow-sm">
              <h3 id="sound-summary-title" class="font-bold text-slate-800">
                음향 상태
              </h3>
              <div class="flex items-center justify-center space-x-6 mt-4">
                <div>
                  <p
                    class="text-3xl font-bold text-blue-600"
                    id="avg-db-summary"
                  >
                    N/A
                  </p>
                  <p class="text-sm text-slate-500 text-center">현재 평균</p>
                </div>
                <div>
                  <p
                    class="text-3xl font-bold text-red-500"
                    id="db-alert-summary"
                  >
                    N/A
                  </p>
                  <p class="text-sm text-slate-500 text-center">현재 경고</p>
                </div>
              </div>
              <div class="mt-6 text-center">
                <p class="text-lg font-semibold text-slate-700">
                  일일 전체 평균
                </p>
                <p
                  class="text-2xl font-bold text-emerald-600"
                  id="daily-avg-summary"
                >
                  N/A
                </p>
              </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-sm md:col-span-2">
              <h3 class="font-bold text-slate-800" id="on-duty-title">
                운영 담당자
              </h3>
              <div
                id="on-duty-list"
                class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-sm mt-4"
              >
                <!-- On-duty staff will be populated by JS -->
              </div>
            </div>
          </div>
        </div>

        <!-- Pre-Setup Content -->
        <div id="setup-content" class="content-panel hidden">
          <div class="mb-6">
            <h2 class="text-xl font-bold mb-1">사전설치 공정표</h2>
            <p class="text-slate-500 text-sm">
              팀별 사전설치 작업의 진행 상태를 관리하고 추적합니다. (읽기 전용)
            </p>
          </div>
          <div class="mb-4 flex space-x-2">
            <button
              data-team="All"
              class="filter-btn team-filter-btn px-3 py-1 text-sm font-semibold rounded-md active"
            >
              전체
            </button>
            <button
              data-team="오디오팀"
              class="filter-btn team-filter-btn px-3 py-1 text-sm font-semibold rounded-md"
            >
              오디오팀
            </button>
            <button
              data-team="비디오팀"
              class="filter-btn team-filter-btn px-3 py-1 text-sm font-semibold rounded-md"
            >
              비디오팀
            </button>
            <button
              data-team="무대팀"
              class="filter-btn team-filter-btn px-3 py-1 text-sm font-semibold rounded-md"
            >
              무대팀
            </button>
            <button
              data-team="IT팀"
              class="filter-btn team-filter-btn px-3 py-1 text-sm font-semibold rounded-md"
            >
              IT팀
            </button>
          </div>
          <div class="bg-white rounded-lg shadow-sm overflow-x-auto">
            <table class="w-full text-sm text-left">
              <thead class="bg-slate-100 text-slate-600">
                <tr>
                  <th class="p-3">팀</th>
                  <th class="p-3">작업 항목</th>
                  <th class="p-3">담당자</th>
                  <th class="p-3">예상 소요</th>
                  <th class="p-3">시작 예정</th>
                  <th class="p-3 text-center">완료 여부</th>
                </tr>
              </thead>
              <tbody id="setup-tasks-table">
                <!-- Setup tasks will be populated by JS -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Operation Content -->
        <div id="operation-content" class="content-panel hidden">
          <div class="mb-6">
            <h2 class="text-xl font-bold mb-1">운영 스케줄</h2>
            <p class="text-slate-500 text-sm">
              날짜를 선택하여 해당일의 시간대별 운영 담당자 정보를 확인합니다.
            </p>
          </div>
          <div class="mb-4 flex space-x-2">
            <button
              data-day="2025-07-04"
              class="filter-btn op-day-filter px-3 py-1 text-sm font-semibold rounded-md active"
            >
              7월 4일 (1일차)
            </button>
            <button
              data-day="2025-07-05"
              class="filter-btn op-day-filter px-3 py-1 text-sm font-semibold rounded-md"
            >
              7월 5일 (2일차)
            </button>
            <button
              data-day="2025-07-06"
              class="filter-btn op-day-filter px-3 py-1 text-sm font-semibold rounded-md"
            >
              7월 6일 (3일차)
            </button>
          </div>
          <div class="bg-white rounded-lg shadow-sm overflow-x-auto">
            <table class="w-full text-sm text-left">
              <thead class="bg-slate-100 text-slate-600">
                <tr>
                  <th class="p-3">시간대</th>
                  <th class="p-3">오디오팀</th>
                  <th class="p-3">비디오팀</th>
                  <th class="p-3">무대팀</th>
                  <th class="p-3">IT팀</th>
                  <th class="p-3">백업 담당자</th>
                </tr>
              </thead>
              <tbody id="operation-schedule-table">
                <!-- Operation schedule will be populated by JS -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Sound Analysis Content -->
        <div id="sound-content" class="content-panel hidden">
          <div class="mb-6">
            <h2 class="text-xl font-bold mb-1">음향 분석</h2>
            <p class="text-slate-500 text-sm">
              좌석별 음향 데시벨 현황을 히트맵으로 시각화하고, 시간대별 변화
              추이를 분석하여 음향 문제를 신속하게 파악하고 대응합니다.
            </p>
          </div>
          <div
            class="bg-white p-4 rounded-lg shadow-sm mb-6 flex items-center space-x-4"
          >
            <div>
              <label
                for="sound-day-filter"
                class="text-sm font-semibold text-slate-600"
                >날짜:</label
              >
              <select
                id="sound-day-filter"
                class="p-2 border rounded-md text-sm"
              >
                <option value="1">1일차</option>
                <option value="2">2일차</option>
                <option value="3">3일차</option>
              </select>
            </div>
            <div>
              <label
                for="sound-time-filter"
                class="text-sm font-semibold text-slate-600"
                >측정회차:</label
              >
              <select
                id="sound-time-filter"
                class="p-2 border rounded-md text-sm"
              >
                <!-- <option value="1">1차 (09:00)</option>
                <option value="2">2차 (13:00)</option>
                <option value="3">3차 (15:00)</option>
                <option value="4">4차 (17:00)</option> -->
              </select>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-lg shadow-sm">
              <h3 class="font-bold text-slate-800 mb-2">
                좌석별 데시벨 히트맵
              </h3>
              <div class="w-full text-center mb-4">
                <div
                  class="inline-block bg-slate-700 text-white font-bold text-lg px-12 py-2 rounded-md shadow-md"
                >
                  STAGE
                </div>
              </div>
              <div class="chart-container h-64">
                <canvas id="soundHeatmapChart"></canvas>
              </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-sm">
              <h3 class="font-bold text-slate-800 mb-4" id="sound-trend-title">
                시간대별 데시벨 트렌드 (1일차)
              </h3>
              <div class="chart-container h-80">
                <canvas id="soundTrendChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Chart.js and plugin scripts moved here to ensure they load before the main script -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

    <script>
      // --- DATA ---
      const db = {
        setupTasks: [],
        operationSchedule: [],
        soundData: [],
        soundSettings: { minDb: 65, maxDb: 80 },
        seatLayout: [
          ["11", null, "12", null, "13"],
          ["6", "7", "8", "9", "10"],
          ["1", "2", "3", "4", "5"],
        ],
      };

      async function loadAllData() {
        try {
          const [setupData, scheduleData, soundData] = await Promise.all([
            fetch("/api/SetupTasks").then((res) => {
              if (!res.ok) throw new Error("Failed to fetch SetupTasks");
              return res.json();
            }),
            fetch("/api/OperationSchedule").then((res) => {
              if (!res.ok) throw new Error("Failed to fetch OperationSchedule");
              return res.json();
            }),
            //   fetch("/api/SoundData").then((res) => {
            //     if (!res.ok) throw new Error("Failed to fetch SoundData");
            //     return res.json();
            //   }),
            fetch("/api2/white-bc-values").then((res) => {
              if (!res.ok) throw new Error("Failed to fetch white-bc-values");
              return res.json();
            }),
          ]);

          db.setupTasks = setupData.map((d) => ({
            ...d,
            id: parseInt(d.id),
            duration: parseInt(d.duration),
            completed: d.completed
              ? d.completed.toUpperCase() === "TRUE"
              : false,
          }));
          db.operationSchedule = scheduleData;
          db.soundData = soundData.map((d) => ({
            day: d.day,
            time: d.time,
            seat: d.seat,
            db: parseFloat(d.db),
          }));
        } catch (error) {
          console.error("Error loading data from API:", error);
          alert(
            "API 서버에서 데이터를 불러오는 데 실패했습니다. 백엔드 서버가 정상적으로 실행 중인지 확인해주세요."
          );
        }
      }

      // --- STATE ---
      const state = {
        activeTab: "dashboard",
        setupFilter: "All",
        operationDay: "2025-07-04",
        soundFilter: { day: 1, time: 1 },
      };

      const charts = {};

      // --- RENDER FUNCTIONS ---
      function renderDashboard() {
        // === 진행률 차트 ===
        const teamProgress = {};
        const teams = [...new Set(db.setupTasks.map((t) => t.team))];
        teams.forEach((team) => {
          const teamTasks = db.setupTasks.filter((t) => t.team === team);
          teamProgress[team] = {
            total: teamTasks.length,
            completed: teamTasks.filter((t) => t.completed).length,
          };
        });

        const overall = {
          total: db.setupTasks.length,
          completed: db.setupTasks.filter((t) => t.completed).length,
        };

        if (overall.total > 0) {
          renderDonutChart(
            "overallProgressChart",
            "전체",
            overall.completed,
            overall.total
          );
          renderDonutChart(
            "audioProgressChart",
            "오디오팀",
            teamProgress["오디오팀"]?.completed || 0,
            teamProgress["오디오팀"]?.total || 0
          );
          renderDonutChart(
            "videoProgressChart",
            "비디오팀",
            teamProgress["비디오팀"]?.completed || 0,
            teamProgress["비디오팀"]?.total || 0
          );
          renderDonutChart(
            "stageProgressChart",
            "무대팀",
            teamProgress["무대팀"]?.completed || 0,
            teamProgress["무대팀"]?.total || 0
          );
          renderDonutChart(
            "itProgressChart",
            "IT팀",
            teamProgress["IT팀"]?.completed || 0,
            teamProgress["IT팀"]?.total || 0
          );
        }

        // === 지연된 작업 표시 ===
        const now = new Date();
        const delayedTasksList = document.getElementById("delayed-tasks-list");
        delayedTasksList.innerHTML = "";
        const delayedTasks = db.setupTasks.filter((task) => {
          if (!task.start) return false;
          const startTime = new Date(task.start);
          const endTime = new Date(startTime.getTime() + task.duration * 60000);
          return !task.completed && now > endTime;
        });

        if (delayedTasks.length > 0) {
          delayedTasks.forEach((task) => {
            delayedTasksList.innerHTML += `
        <div class="flex justify-between items-center bg-red-50 p-2 rounded">
          <span><span class="font-semibold">${task.team}</span> - ${task.task}</span>
          <span class="text-red-600 font-bold">지연</span>
        </div>`;
          });
        } else {
          delayedTasksList.innerHTML = `<p class="text-slate-500">지연된 작업이 없습니다.</p>`;
        }

        // === 음향 상태 요약 ===
        const competitionDateMap = {
          1: "2025-07-04",
          2: "2025-07-05",
          3: "2025-07-06",
        };
        let closestDataGroup = [];
        let dayToDisplay = 1;
        let minDiff = Infinity;

        for (const [dayStr, dateStr] of Object.entries(competitionDateMap)) {
          const thisDay = parseInt(dayStr);
          const dateBase = new Date(`${dateStr}T00:00:00+09:00`);
          const dataOfDay = db.soundData.filter((d) => d.day === thisDay);
          const groupedByTime = {};

          for (const d of dataOfDay) {
            if (!groupedByTime[d.time]) groupedByTime[d.time] = [];
            groupedByTime[d.time].push(d);
          }

          for (const [timeKey, group] of Object.entries(groupedByTime)) {
            const timeStr = extractTimePart(timeKey);
            if (!timeStr) continue;

            const parsedTime = parseTimeStringToDate(timeStr);
            const fullDateTime = new Date(dateBase);
            fullDateTime.setHours(
              parsedTime.getHours(),
              parsedTime.getMinutes()
            );

            const diff = Math.abs(now - fullDateTime);
            if (diff < minDiff) {
              minDiff = diff;
              dayToDisplay = thisDay;
              closestDataGroup = group;
            }
          }
        }

        document.getElementById(
          "sound-summary-title"
        ).textContent = `음향 상태 (${dayToDisplay}일차)`;

        const avgDb =
          closestDataGroup.reduce((acc, d) => acc + d.db, 0) /
          (closestDataGroup.length || 1);
        document.getElementById(
          "avg-db-summary"
        ).textContent = `${avgDb.toFixed(1)} dB`;

        const alertCount = closestDataGroup.filter(
          (d) => d.db < db.soundSettings.minDb || d.db > db.soundSettings.maxDb
        ).length;
        document.getElementById(
          "db-alert-summary"
        ).textContent = `${alertCount} 곳`;

        const dailyData = db.soundData.filter((d) => d.day === dayToDisplay);
        const dailyAvg =
          dailyData.reduce((acc, d) => acc + d.db, 0) / dailyData.length;
        document.getElementById(
          "daily-avg-summary"
        ).textContent = `${dailyAvg.toFixed(1)} dB`;

        function extractTimePart(timeStr) {
          const match = timeStr.match(/\((오전|오후)\s*\d{1,2}:\d{2}\)/);
          return match ? match[0].replace(/[()]/g, "") : null;
        }

        function parseTimeStringToDate(timeStr) {
          const [amPm, time] = timeStr.trim().split(" ");
          let [hour, minute] = time.split(":").map(Number);
          if (amPm === "오후" && hour !== 12) hour += 12;
          if (amPm === "오전" && hour === 12) hour = 0;
          const date = new Date();
          date.setHours(hour, minute, 0, 0);
          return date;
        }

        // === 운영 담당자 표시 ===
        const onDutyList = document.getElementById("on-duty-list");
        if (db.operationSchedule.length > 0) {
          const todayStr = now.toISOString().slice(0, 10);
          const currentHour = now.getHours();

          const currentDaySchedule = db.operationSchedule.filter(
            (s) => s.date === todayStr
          );

          let currentDuty = currentDaySchedule.find((slot) => {
            const [startStr, endStr] = slot.time
              .split("-")
              .map((s) => s.trim());
            const [startHour] = startStr.split(":").map(Number);
            const [endHour] = endStr.split(":").map(Number);
            return currentHour >= startHour && currentHour < endHour;
          });

          if (!currentDuty && currentDaySchedule.length > 0) {
            currentDuty = currentDaySchedule[0];
          }
          if (!currentDuty) {
            currentDuty = db.operationSchedule[0];
          }

          document.getElementById(
            "on-duty-title"
          ).textContent = `운영 담당자 (${currentDuty.date}, ${currentDuty.time})`;

          onDutyList.innerHTML = `
      <div><p class="font-semibold text-slate-700">오디오</p><p class="text-slate-500">${currentDuty.audio}</p></div>
      <div><p class="font-semibold text-slate-700">비디오</p><p class="text-slate-500">${currentDuty.video}</p></div>
      <div><p class="font-semibold text-slate-700">무대</p><p class="text-slate-500">${currentDuty.stage}</p></div>
      <div><p class="font-semibold text-slate-700">IT</p><p class="text-slate-500">${currentDuty.it}</p></div>
    `;
        }
      }

      function renderDonutChart(canvasId, label, completed, total) {
        const ctx = document.getElementById(canvasId).getContext("2d");
        if (charts[canvasId]) charts[canvasId].destroy();

        const percentage =
          total > 0 ? Math.round((completed / total) * 100) : 0;
        const data = total > 0 ? [completed, total - completed] : [0, 1];

        charts[canvasId] = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: ["완료", "미완료"],
            datasets: [
              {
                data: data,
                backgroundColor: ["#22c55e", "#e2e8f0"],
                borderColor: ["#ffffff"],
                borderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: "70%",
            plugins: {
              legend: { display: false },
              tooltip: { enabled: false },
              title: {
                display: true,
                text: `${percentage}%`,
                position: "bottom",
                align: "center",
                font: {
                  size:
                    window.innerWidth <= 768
                      ? canvasId.includes("overall")
                        ? 24
                        : 24 // 모바일에서 더 큼
                      : canvasId.includes("overall")
                      ? 24
                      : 14,
                },
                color: "#334155",
                padding: {
                  top:
                    window.innerWidth <= 768
                      ? canvasId.includes("overall")
                        ? -55
                        : -70
                      : canvasId.includes("overall")
                      ? -65
                      : -35,
                },
              },
            },
          },
        });
      }

      function renderSetupTable() {
        const tableBody = document.getElementById("setup-tasks-table");
        tableBody.innerHTML = "";
        const filteredTasks = db.setupTasks.filter(
          (task) =>
            state.setupFilter === "All" || task.team === state.setupFilter
        );
        const now = new Date();

        filteredTasks.forEach((task) => {
          const startTime = task.start ? new Date(task.start) : null;
          const endTime = startTime
            ? new Date(startTime.getTime() + task.duration * 60000)
            : null;

          let rowClass = "";
          if (task.completed) {
            rowClass = "completed";
          } else if (endTime && now > endTime) {
            rowClass = "delayed";
          } else if (
            startTime &&
            endTime &&
            now >= startTime &&
            now <= endTime
          ) {
            rowClass = "in-progress";
          }

          const tr = document.createElement("tr");
          tr.className = `task-row border-b border-slate-200 hover:bg-slate-50 ${rowClass}`;
          tr.innerHTML = `
                    <td class="p-3"><span class="px-2 py-1 text-xs font-semibold rounded-full bg-slate-200 text-slate-700">${
                      task.team
                    }</span></td>
                    <td class="p-3 font-semibold">${task.task}</td>
                    <td class="p-3">${task.person}</td>
                    <td class="p-3">${task.duration}분</td>
                    <td class="p-3">${
                      startTime
                        ? startTime.toLocaleString("ko-KR", {
                            year: "numeric",
                            month: "2-digit",
                            day: "2-digit",
                            hour: "2-digit",
                            minute: "2-digit",
                          })
                        : "미정"
                    }</td>
                    <td class="p-3 text-center">
                        <input type="checkbox" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${
                          task.completed ? "checked" : ""
                        } disabled>
                    </td>
                `;
          tableBody.appendChild(tr);
        });
      }

      function renderOperationSchedule() {
        const tableBody = document.getElementById("operation-schedule-table");
        tableBody.innerHTML = "";
        const filteredSchedule = db.operationSchedule.filter(
          (slot) => slot.date === state.operationDay
        );

        filteredSchedule.forEach((slot) => {
          tableBody.innerHTML += `
                    <tr class="border-b border-slate-200 hover:bg-slate-50">
                        <td class="p-3 font-semibold">${slot.time}</td>
                        <td class="p-3">${slot.audio}</td>
                        <td class="p-3">${slot.video}</td>
                        <td class="p-3">${slot.stage}</td>
                        <td class="p-3">${slot.it}</td>
                        <td class="p-3">${slot.backup}</td>
                    </tr>
                `;
        });
      }

      function renderSoundAnalysis() {
        const timeFilterEl = document.getElementById("sound-time-filter");
        timeFilterEl.innerHTML = ""; // 기존 옵션 제거

        const currentDay = parseInt(
          document.getElementById("sound-day-filter").value || "1"
        );

        // 현재 day의 고유한 time 라벨 추출
        const timeLabels = Array.from(
          new Set(
            db.soundData.filter((d) => d.day === currentDay).map((d) => d.time)
          )
        );

        // 드롭다운 옵션 생성
        timeLabels.forEach((label) => {
          const option = document.createElement("option");
          option.value = label;
          option.textContent = label;
          if (label === state.soundFilter.time) {
            option.selected = true;
          }
          timeFilterEl.appendChild(option);
        });

        // state 초기화 (필요 시)
        if (!timeLabels.includes(state.soundFilter.time)) {
          state.soundFilter.time = timeLabels[0];
        }

        state.soundFilter.day = currentDay;
        timeFilterEl.value = state.soundFilter.time;

        const { day, time } = state.soundFilter;

        // heatmap용 필터링
        const filteredData = db.soundData.filter(
          (d) => d.day === day && d.time === time
        );

        const heatmapDataPoints = [];
        const maxCols = Math.max(...db.seatLayout.map((r) => r.length));

        db.seatLayout.forEach((row, rowIndex) => {
          const offset = (maxCols - row.length) / 2;
          row.forEach((seat, seatIndex) => {
                    // seat 값이 null이 아닐 경우에만 데이터 포인트를 생성합니다.
                    if (seat) { 
                        const seatData = filteredData.find(d => d.seat === seat);
                        heatmapDataPoints.push({
                            x: seatIndex, // 배열의 인덱스를 x좌표로 바로 사용합니다.
                            y: rowIndex,
                            v: seatData ? seatData.db : null,
                            seatName: seat
                        });
          });
        });

        const heatmapData = {
          datasets: [
            {
              label: "Seat Decibels",
              data: heatmapDataPoints,
              backgroundColor: (c) => getColorForDb(c.raw.v),
              borderColor: "rgba(255, 255, 255, 0.5)",
              borderWidth: 1,
              radius: 20,
            },
          ],
        };
        renderHeatmapChart(heatmapData);

        // 트렌드 차트 구성
        const trendData = {
          labels: timeLabels,
          datasets: [
            {
              label: `일일 평균 데시벨`,
              data: timeLabels.map((label) => {
                const timeData = db.soundData.filter(
                  (d) => d.day === currentDay && d.time === label
                );
                return timeData.length
                  ? timeData.reduce((acc, d) => acc + d.db, 0) / timeData.length
                  : NaN;
              }),
              borderColor: "#3b82f6",
              backgroundColor: "rgba(59, 130, 246, 0.1)",
              fill: true,
              tension: 0.2,
            },
          ],
        };

        renderTrendChart(trendData);
        document.getElementById(
          "sound-trend-title"
        ).textContent = `시간대별 데시벨 트렌드 (${day}일차)`;
      }

      function renderHeatmapChart(data) {
        const ctx = document
          .getElementById("soundHeatmapChart")
          .getContext("2d");
        if (charts.heatmap) charts.heatmap.destroy();

        const maxCols = Math.max(...db.seatLayout.map(r => r.length));

            charts.heatmap = new Chart(ctx, {
                type: 'bubble',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: { padding: 5 },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: (context) => `좌석: ${context[0].raw.seatName}`,
                                label: (context) => { 
                                    const value = context.raw.v;
                                    return value !== null ? `데시벨: ${value.toFixed(1)} dB` : '데이터 없음';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            min: -0.5,
                            max: db.seatLayout.length - 0.5, // Y축 범위는 그대로 유지
                            grid: { display: false },
                            ticks: { display: false }
                        },
                        x: {
                            min: -0.5,
                            max: maxCols - 0.5, // X축 범위를 가장 긴 줄에 맞게 고정
                            grid: { display: false },
                            ticks: { display: false }
                        }
                    }
                }
            });
      }

      function renderTrendChart(data) {
        const ctx = document.getElementById("soundTrendChart").getContext("2d");
        if (charts.trend) charts.trend.destroy();
        charts.trend = new Chart(ctx, {
          type: "line",
          data: data,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: false,
                suggestedMin: 60,
                suggestedMax: 95,
                title: { display: true, text: "평균 데시벨(dB)" },
              },
            },
            plugins: {
              legend: { display: false },
              annotation: {
                annotations: {
                  normalRange: {
                    type: "box",
                    yMin: 65,
                    yMax: 80,
                    backgroundColor: "rgba(74, 222, 128, 0.15)",
                    borderColor: "rgba(34, 197, 94, 0.3)",
                    borderWidth: 1,
                    borderDash: [6, 6],
                    label: {
                      content: "평상시",
                      display: true,
                      position: "start",
                      font: { size: 10 },
                      color: "rgba(22, 101, 52, 0.7)",
                    },
                  },
                  // --- 85데시벨 경고 기준선 (수정된 부분) ---
                  criticalLine: {
                    type: "box",
                    yMin: 85, // yValue 대신 yMin 사용
                    yMax: 85, // yValue 대신 yMax 사용
                    scaleID: "y",
                    borderColor: "rgb(239, 68, 68)",
                    borderWidth: 2,
                    borderDash: [6, 6],
                    label: {
                      content: "경고 기준",
                      display: true,
                      position: "end",
                      font: { weight: "bold" },
                      color: "rgb(239, 68, 68)",
                      backgroundColor: "rgba(255, 255, 255, 0.5)",
                    },
                  },
                },
              },
            },
          },
        });
      }

      function getColorForDb(dbValue) {
        if (dbValue === null || dbValue === undefined) {
          return "rgba(226, 232, 240, 0.8)"; // Gray for no data
        }

        if (dbValue > 80) {
          return "rgba(239, 68, 68, 0.8)"; // 80 초과 (붉은색)
        } else if (dbValue >= 75) {
          // 75-80: 라임색 -> 주황색 그라데이션
          const intensity = (dbValue - 75) / (80 - 75);
          const r = Math.round(163 + (251 - 163) * intensity);
          const g = Math.round(230 + (191 - 230) * intensity);
          const b = Math.round(53 + (36 - 53) * intensity);
          return `rgba(${r}, ${g}, ${b}, 0.8)`;
        } else if (dbValue >= 75) {
          return "rgba(74, 222, 128, 0.8)"; // 65-75: 녹색
        } else if (dbValue >= 65) {
          // 50-65: 회색 -> 녹색 그라데이션
          const intensity = (dbValue - 50) / (65 - 50);
          const r = Math.round(209 + (74 - 209) * intensity);
          const g = Math.round(213 + (222 - 213) * intensity);
          const b = Math.round(219 + (128 - 219) * intensity);
          return `rgba(${r}, ${g}, ${b}, 0.8)`;
        } else {
          return "rgba(209, 213, 219, 0.8)"; // 50 미만 (회색)
        }
      }

      // --- EVENT HANDLERS & INITIALIZATION ---
      function handleNavClick(e) {
        if (!e.target.dataset.tab) return;
        state.activeTab = e.target.dataset.tab;
        updateView();
      }

      function handleFilterClick(e) {
        const btn = e.target.closest(".filter-btn");
        if (!btn) return;

        if (btn.classList.contains("team-filter-btn")) {
          state.setupFilter = btn.dataset.team;
          document
            .querySelectorAll(".team-filter-btn")
            .forEach((b) => b.classList.remove("active"));
          renderSetupTable();
        } else if (btn.classList.contains("op-day-filter")) {
          state.operationDay = btn.dataset.day;
          document
            .querySelectorAll(".op-day-filter")
            .forEach((b) => b.classList.remove("active"));
          renderOperationSchedule();
        }
        btn.classList.add("active");
      }

      function handleSoundFilterChange() {
        state.soundFilter.day = parseInt(
          document.getElementById("sound-day-filter").value
        );
        state.soundFilter.time =
          document.getElementById("sound-time-filter").value;

        renderSoundAnalysis();
      }

      function updateView() {
        document
          .querySelectorAll(".content-panel")
          .forEach((panel) => panel.classList.add("hidden"));
        document
          .getElementById(`${state.activeTab}-content`)
          .classList.remove("hidden");

        document
          .querySelectorAll(".tab-btn")
          .forEach((btn) =>
            btn.classList.toggle("active", btn.dataset.tab === state.activeTab)
          );

        switch (state.activeTab) {
          case "dashboard":
            renderDashboard();
            break;
          case "setup":
            renderSetupTable();
            break;
          case "operation":
            renderOperationSchedule();
            break;
          case "sound":
            renderSoundAnalysis();
            break;
        }
      }

      window.onload = async () => {
        const loadingOverlay = document.getElementById("loading-overlay");

        // Register Chart.js plugin only if it exists
        if (window.ChartAnnotation) {
          Chart.register(window.ChartAnnotation);
        }

        await loadAllData();

        loadingOverlay.style.opacity = "0";
        setTimeout(() => (loadingOverlay.style.display = "none"), 300);

        // Set up event listeners
        document
          .getElementById("refresh-button")
          .addEventListener("click", async () => {
            loadingOverlay.style.display = "flex";
            loadingOverlay.style.opacity = "1";
            await loadAllData();
            updateView();
            loadingOverlay.style.opacity = "0";
            setTimeout(() => (loadingOverlay.style.display = "none"), 300);
          });

        document.querySelector("nav").addEventListener("click", handleNavClick);
        document
          .getElementById("setup-content")
          .addEventListener("click", handleFilterClick);
        document
          .getElementById("operation-content")
          .addEventListener("click", handleFilterClick);
        document
          .getElementById("sound-day-filter")
          .addEventListener("change", handleSoundFilterChange);
        document
          .getElementById("sound-time-filter")
          .addEventListener("change", handleSoundFilterChange);

        // Initial render
        document
          .querySelector('.tab-btn[data-tab="dashboard"]')
          .classList.add("active");
        updateView();
      };
    </script>
  </body>
</html>
